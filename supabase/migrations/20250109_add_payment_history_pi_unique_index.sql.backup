-- Add explicit unique index on payment_history.stripe_payment_intent_id for idempotency
-- This ensures upsert operations work correctly and provides clear indexing for performance
-- Note: The UNIQUE constraint already creates an index, but this makes it explicit and named

CREATE UNIQUE INDEX IF NOT EXISTS payment_history_payment_intent_uidx
  ON payment_history (stripe_payment_intent_id);

-- Add comment to document the purpose
COMMENT ON INDEX payment_history_payment_intent_uidx IS 
  'Ensures idempotency for payment history records via stripe_payment_intent_id. Used by webhook handlers to prevent duplicate payment records.';

